 var hwcrypto = (function hwcrypto(){'use strict';var _debug = function(x){};_debug("hwcrypto.js activated");window.addEventListener = window.addEventListener || window.attachEvent;function hasPluginFor(mime){return navigator.mimeTypes && mime in navigator.mimeTypes;} function hasExtensionFor(cls){return typeof window[cls] === 'function';} function _hex2array(str){if(typeof str == 'string'){var len = Math.floor(str.length / 2);var ret = new Uint8Array(len);for (var i = 0;i < len;i++){ret[i] = parseInt(str.substr(i * 2,2),16);} return ret;} } function _array2hex(args){var ret = "";for(var i = 0;i < args.length;i++) ret += (args[i] < 16 ? "0":"") + args[i].toString(16);return ret.toLowerCase();} function _mimeid(mime){return "hwc" + mime.replace('/','').replace('-','');} function loadPluginFor(mime){var element = _mimeid(mime);if(document.getElementById(element)){_debug("Plugin element already loaded");return document.getElementById(element);} _debug('Loading plugin for ' + mime + ' into ' + element);var objectTag = '<object id="' + element + '" type="' + mime + '" style="width:1px;height:1px;position:absolute;visibility:hidden;"></object>';var div = document.createElement("div");div.setAttribute("id",'pluginLocation' + element);document.body.appendChild(div);document.getElementById('pluginLocation' + element).innerHTML = objectTag;return document.getElementById(element);} var digidoc_mime = 'application/x-digidoc';var digidoc_chrome = 'TokenSigning';var USER_CANCEL = "user_cancel";var NO_CERTIFICATES = "no_certificates";var INVALID_ARGUMENT = "invalid_argument";var TECHNICAL_ERROR = "technical_error";var NO_IMPLEMENTATION = "no_implementation";var NOT_ALLOWED = "not_allowed";function probe(){var msg = 'probe() detected ';if(hasExtensionFor(digidoc_chrome)){_debug(msg + digidoc_chrome);} if(hasPluginFor(digidoc_mime)){_debug(msg + digidoc_mime);} } window.addEventListener('load',function(event){probe();});function DigiDocPlugin(){this._name = "NPAPI/BHO for application/x-digidoc";var p = loadPluginFor(digidoc_mime);var certificate_ids ={};function code2str(err){_debug("Error:" + err + " with:" + p.errorMessage);switch(parseInt(err)){case 1:return USER_CANCEL;case 2:return INVALID_ARGUMENT;case 17:return INVALID_ARGUMENT;case 19:return NOT_ALLOWED;default:_debug("Unknown error:" + err + " with:" + p.errorMessage);return TECHNICAL_ERROR;} } function code2err(err){return new Error(code2str(err));} this.check = function(){return new Promise(function(resolve,reject){setTimeout(function(){resolve(typeof p.version !== "undefined");},0);});};this.getVersion = function(){return new Promise(function(resolve,reject){var v = p.version;resolve(v);});};this.getCertificate = function(options){if(options && options.lang){p.pluginLanguage = options.lang;} return new Promise(function(resolve,reject){try{var v = p.getCertificate();if(parseInt(p.errorCode) !== 0){reject(code2err(p.errorCode));} else{certificate_ids[v.cert] = v.id;resolve({hex:v.cert });} } catch(ex){_debug(ex);reject(code2err(p.errorCode));} });};this.sign = function(cert,hash,options){return new Promise(function(resolve,reject){var cid = certificate_ids[cert.hex];if(cid){try{var language = options.lang || 'en';var v = p.sign(cid,hash.hex,language);resolve({hex:v });} catch(ex){_debug(JSON.stringify(ex));reject(code2err(p.errorCode));} } else{_debug("invalid certificate:" + cert);reject(new Error(INVALID_ARGUMENT));} });};} function DigiDocExtension(){this._name = "Chrome native messaging extension";var p = null;this.check = function(){return new Promise(function(resolve,reject){if (!hasExtensionFor(digidoc_chrome)){return resolve(false);} p = new window[digidoc_chrome]();if (p){resolve(true);} else{resolve(false);} });};this.getVersion = function(){return p.getVersion();};this.getCertificate = function(options){return p.getCertificate(options);};this.sign = function(cert,hash,options){return p.sign(cert,hash,options);};} function NoBackend(){this._name = "No implementation";this.check = function(){return new Promise(function(resolve,reject){resolve(true);});};this.getVersion = function(){return Promise.reject(new Error(NO_IMPLEMENTATION));};this.getCertificate = function(){return Promise.reject(new Error(NO_IMPLEMENTATION));};this.sign = function(){return Promise.reject(new Error(NO_IMPLEMENTATION));};} var _backend = null;var fields ={};function _testAndUse(Backend){return new Promise(function(resolve,reject){var b = new Backend();b.check().then(function(isLoaded){if (isLoaded){_debug("Using backend:" + b._name);_backend = b;resolve(true);} else{_debug(b._name + " check() failed");resolve(false);} });});} function _autodetect(force){return new Promise(function(resolve,reject){_debug("Autodetecting best backend");if (typeof force === 'undefined'){force = false;} if (_backend !== null && !force){return resolve(true);} function tryDigiDocPlugin(){_testAndUse(DigiDocPlugin).then(function(result){if (result){resolve(true);} else{resolve(_testAndUse(NoBackend));} });} if (navigator.userAgent.indexOf("MSIE") != -1 || navigator.userAgent.indexOf("Trident") != -1){_debug("Assuming IE BHO,testing");return tryDigiDocPlugin();} if (navigator.userAgent.indexOf("Chrome") != -1 && hasExtensionFor(digidoc_chrome)){_testAndUse(DigiDocExtension).then(function(result){if (result){resolve(true);} else{tryDigiDocPlugin();} });return;} if (hasPluginFor(digidoc_mime)){return tryDigiDocPlugin();} resolve(_testAndUse(NoBackend));});} fields.use = function(backend){return new Promise(function(resolve,reject){if (typeof backend === "undefined" || backend === 'auto'){_autodetect().then(function(result){resolve(result);});} else{if (backend === "chrome"){resolve(_testAndUse(DigiDocExtension));} else if (backend === "npapi"){resolve(_testAndUse(DigiDocPlugin));} else{resolve(false);} } });};fields.debug = function(){return new Promise(function(resolve,reject){var hwversion = "hwcrypto.js @@hwcryptoversion";_autodetect().then(function(result){_backend.getVersion().then(function(version){resolve(hwversion + " with " + _backend._name + " " + version);},function(error){resolve(hwversion + " with failing backend " + _backend._name);});});});};fields.getCertificate = function(options){if(typeof options !== 'object'){_debug("getCertificate options parameter must be an object");return Promise.reject(new Error(INVALID_ARGUMENT));} if(options && !options.lang){options.lang = 'en';} return _autodetect().then(function(result){if (location.protocol !== 'https:' && location.protocol !== 'file:'){return Promise.reject(new Error(NOT_ALLOWED));} return _backend.getCertificate(options).then(function(certificate){if (certificate.hex && !certificate.encoded) certificate.encoded = _hex2array(certificate.hex);return certificate;});});};fields.sign = function(cert,hash,options){if (arguments.length < 2) return Promise.reject(new Error(INVALID_ARGUMENT));if(options && !options.lang){options.lang = 'en';} if (!hash.type || (!hash.value && !hash.hex)) return Promise.reject(new Error(INVALID_ARGUMENT));if (hash.hex && !hash.value){_debug("DEPRECATED:hash.hex as argument to sign() is deprecated,use hash.value instead");hash.value = _hex2array(hash.hex);} if (hash.value && !hash.hex) hash.hex = _array2hex(hash.value);return _autodetect().then(function(result){if(location.protocol !== 'https:' && location.protocol !== 'file:'){return Promise.reject(new Error(NOT_ALLOWED));} return _backend.sign(cert,hash,options).then(function(signature){if (signature.hex && !signature.value) signature.value = _hex2array(signature.hex);return signature;});});};fields.NO_IMPLEMENTATION = NO_IMPLEMENTATION;fields.USER_CANCEL = USER_CANCEL;fields.NOT_ALLOWED = NOT_ALLOWED;fields.NO_CERTIFICATES = NO_CERTIFICATES;fields.TECHNICAL_ERROR = TECHNICAL_ERROR;fields.INVALID_ARGUMENT = INVALID_ARGUMENT;return fields;}());(function (){"use strict";var max = 10000000000000;function Int10(value){this.buf = [+value || 0];} Int10.prototype.mulAdd = function (m,c){var b = this.buf,l = b.length,i,t;for (i = 0;i < l;++i){t = b[i] * m + c;if (t < max) c = 0;else{c = 0|(t / max);t -= c * max;} b[i] = t;} if (c > 0) b[i] = c;};Int10.prototype.toString = function (base){if ((base || 10) != 10) throw 'only base 10 is supported';var b = this.buf,s = b[b.length - 1].toString();for (var i = b.length - 2;i >= 0;--i) s += (max + b[i]).toString().substring(1);return s;};Int10.prototype.valueOf = function (){var b = this.buf,v = 0;for (var i = b.length - 1;i >= 0;--i) v = v * max + b[i];return v;};Int10.prototype.simplify = function (){var b = this.buf;return (b.length == 1) ? b[0]:this;};if (typeof module !== 'undefined'){module.exports = Int10;} else{window.Int10 = Int10;} })();(function (undefined){"use strict";var Hex ={},decoder;Hex.decode = function(a){var i;if (decoder === undefined){var hex = "0123456789ABCDEF",ignore = " \f\n\r\t\u00A0\u2028\u2029";decoder = [];for (i = 0;i < 16;++i) decoder[hex.charAt(i)] = i;hex = hex.toLowerCase();for (i = 10;i < 16;++i) decoder[hex.charAt(i)] = i;for (i = 0;i < ignore.length;++i) decoder[ignore.charAt(i)] = -1;} var out = [],bits = 0,char_count = 0;for (i = 0;i < a.length;++i){var c = a.charAt(i);if (c == '=') break;c = decoder[c];if (c == -1) continue;if (c === undefined) throw 'Illegal character at offset ' + i;bits |= c;if (++char_count >= 2){out[out.length] = bits;bits = 0;char_count = 0;} else{bits <<= 4;} } if (char_count) throw "Hex encoding incomplete:4 bits missing";return out;};if (typeof module !== 'undefined'){module.exports = Hex;} else{window.Hex = Hex;} })();(function (undefined){"use strict";var Int10 = (typeof module !== 'undefined') ? require('./int10.js'):window.Int10,ellipsis = "\u2026",reTimeS = /^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/,reTimeL = /^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/;function stringCut(str,len){if (str.length > len) str = str.substring(0,len) + ellipsis;return str;} function Stream(enc,pos){if (enc instanceof Stream){this.enc = enc.enc;this.pos = enc.pos;} else{this.enc = enc;this.pos = pos;} } Stream.prototype.get = function (pos){if (pos === undefined) pos = this.pos++;if (pos >= this.enc.length) throw 'Requesting byte offset ' + pos + ' on a stream of length ' + this.enc.length;return (typeof this.enc == "string") ? this.enc.charCodeAt(pos):this.enc[pos];};Stream.prototype.hexDigits = "0123456789ABCDEF";Stream.prototype.hexByte = function (b){return this.hexDigits.charAt((b >> 4) & 0xF) + this.hexDigits.charAt(b & 0xF);};Stream.prototype.hexDump = function (start,end,raw){var s = "";for (var i = start;i < end;++i){s += this.hexByte(this.get(i));if (raw !== true) switch (i & 0xF){case 0x7:s += " ";break;case 0xF:s += "\n";break;default:s += " ";} } return s;};Stream.prototype.isASCII = function (start,end){for (var i = start;i < end;++i){var c = this.get(i);if (c < 32 || c > 176) return false;} return true;};Stream.prototype.parseStringISO = function (start,end){var s = "";for (var i = start;i < end;++i) s += String.fromCharCode(this.get(i));return s;};Stream.prototype.parseStringUTF = function (start,end){var s = "";for (var i = start;i < end;){var c = this.get(i++);if (c < 128) s += String.fromCharCode(c);else if ((c > 191) && (c < 224)) s += String.fromCharCode(((c & 0x1F) << 6) | (this.get(i++) & 0x3F));else s += String.fromCharCode(((c & 0x0F) << 12) | ((this.get(i++) & 0x3F) << 6) | (this.get(i++) & 0x3F));} return s;};Stream.prototype.parseStringBMP = function (start,end){var str = "",hi,lo;for (var i = start;i < end;){hi = this.get(i++);lo = this.get(i++);str += String.fromCharCode((hi << 8) | lo);} return str;};Stream.prototype.parseTime = function (start,end,shortYear){var s = this.parseStringISO(start,end),m = (shortYear ? reTimeS:reTimeL).exec(s);if (!m) return "Unrecognized time:" + s;if (shortYear){m[1] = +m[1];m[1] += (m[1] < 70) ? 2000:1900;} s = m[1] + "-" + m[2] + "-" + m[3] + " " + m[4];if (m[5]){s += ":" + m[5];if (m[6]){s += ":" + m[6];if (m[7]) s += "." + m[7];} } if (m[8]){s += " UTC";if (m[8] != 'Z'){s += m[8];if (m[9]) s += ":" + m[9];} } return s;};Stream.prototype.parseInteger = function (start,end){var v = this.get(start),neg = (v > 127),pad = neg ? 255:0,len,s = '';while (v == pad && ++start < end) v = this.get(start);len = end - start;if (len === 0) return neg ? -1:0;if (len > 4){s = v;len <<= 3;while (((s ^ pad) & 0x80) == 0){s <<= 1;--len;} s = "(" + len + " bit)\n";} if (neg) v = v - 256;var n = new Int10(v);for (var i = start + 1;i < end;++i) n.mulAdd(256,this.get(i));return s + n.toString();};Stream.prototype.parseBitString = function (start,end,maxLength){var unusedBit = this.get(start),lenBit = ((end - start - 1) << 3) - unusedBit,intro = "(" + lenBit + " bit)\n",s = "";for (var i = start + 1;i < end;++i){var b = this.get(i),skip = (i == end - 1) ? unusedBit:0;for (var j = 7;j >= skip;--j) s += (b >> j) & 1 ? "1":"0";if (s.length > maxLength) return intro + stringCut(s,maxLength);} return intro + s;};Stream.prototype.parseOctetString = function (start,end,maxLength){if (this.isASCII(start,end)) return stringCut(this.parseStringISO(start,end),maxLength);var len = end - start,s = "(" + len + " byte)\n";maxLength /= 2;if (len > maxLength) end = start + maxLength;for (var i = start;i < end;++i) s += this.hexByte(this.get(i));if (len > maxLength) s += ellipsis;return s;};Stream.prototype.parseOID = function (start,end,maxLength){var s = '',n = new Int10(),bits = 0;for (var i = start;i < end;++i){var v = this.get(i);n.mulAdd(128,v & 0x7F);bits += 7;if (!(v & 0x80)){if (s === ''){n = n.simplify();var m = n < 80 ? n < 40 ? 0:1:2;s = m + "." + (n - m * 40);} else s += "." + n.toString();if (s.length > maxLength) return stringCut(s,maxLength);n = new Int10();bits = 0;} } if (bits > 0) s += ".incomplete";return s;};function ASN1(stream,header,length,tag,sub){if (!(tag instanceof ASN1Tag)) throw 'Invalid tag value.';this.stream = stream;this.header = header;this.length = length;this.tag = tag;this.sub = sub;} ASN1.prototype.typeName = function (){switch (this.tag.tagClass){case 0:switch (this.tag.tagNumber){case 0x00:return "EOC";case 0x01:return "BOOLEAN";case 0x02:return "INTEGER";case 0x03:return "BIT_STRING";case 0x04:return "OCTET_STRING";case 0x05:return "NULL";case 0x06:return "OBJECT_IDENTIFIER";case 0x07:return "ObjectDescriptor";case 0x08:return "EXTERNAL";case 0x09:return "REAL";case 0x0A:return "ENUMERATED";case 0x0B:return "EMBEDDED_PDV";case 0x0C:return "UTF8String";case 0x10:return "SEQUENCE";case 0x11:return "SET";case 0x12:return "NumericString";case 0x13:return "PrintableString";case 0x14:return "TeletexString";case 0x15:return "VideotexString";case 0x16:return "IA5String";case 0x17:return "UTCTime";case 0x18:return "GeneralizedTime";case 0x19:return "GraphicString";case 0x1A:return "VisibleString";case 0x1B:return "GeneralString";case 0x1C:return "UniversalString";case 0x1E:return "BMPString";} return "Universal_" + this.tag.tagNumber.toString();case 1:return "Application_" + this.tag.tagNumber.toString();case 2:return "[" + this.tag.tagNumber.toString() + "]";case 3:return "Private_" + this.tag.tagNumber.toString();} };ASN1.prototype.content = function (maxLength){if (this.tag === undefined) return null;if (maxLength === undefined) maxLength = Infinity;var content = this.posContent(),len = Math.abs(this.length);if (!this.tag.isUniversal()){if (this.sub !== null) return "(" + this.sub.length + " elem)";return this.stream.parseOctetString(content,content + len,maxLength);} switch (this.tag.tagNumber){case 0x01:return (this.stream.get(content) === 0) ? "false":"true";case 0x02:return this.stream.parseInteger(content,content + len);case 0x03:return this.sub ? "(" + this.sub.length + " elem)":this.stream.parseBitString(content,content + len,maxLength);case 0x04:return this.sub ? "(" + this.sub.length + " elem)":this.stream.parseOctetString(content,content + len,maxLength);case 0x06:return this.stream.parseOID(content,content + len,maxLength);case 0x10:case 0x11:return "(" + this.sub.length + " elem)";case 0x0C:return stringCut(this.stream.parseStringUTF(content,content + len),maxLength);case 0x12:case 0x13:case 0x14:case 0x15:case 0x16:case 0x1A:return stringCut(this.stream.parseStringISO(content,content + len),maxLength);case 0x1E:return stringCut(this.stream.parseStringBMP(content,content + len),maxLength);case 0x17:case 0x18:return this.stream.parseTime(content,content + len,(this.tag.tagNumber == 0x17));} return null;};ASN1.prototype.toString = function (){return this.typeName() + "@" + this.stream.pos + "[header:" + this.header + ",length:" + this.length + ",sub:" + ((this.sub === null) ? 'null':this.sub.length) + "]";};ASN1.prototype.toPrettyString = function (indent){if (indent === undefined) indent = '';var s = indent + this.typeName() + " @" + this.stream.pos;if (this.length >= 0) s += "+";s += this.length;if (this.tag.tagConstructed) s += " (constructed)";else if ((this.tag.isUniversal() && ((this.tag.tagNumber == 0x03) || (this.tag.tagNumber == 0x04))) && (this.sub !== null)) s += " (encapsulates)";s += "\n";if (this.sub !== null){indent += ' ';for (var i = 0,max = this.sub.length;i < max;++i) s += this.sub[i].toPrettyString(indent);} return s;};ASN1.prototype.posStart = function (){return this.stream.pos;};ASN1.prototype.posContent = function (){return this.stream.pos + this.header;};ASN1.prototype.posEnd = function (){return this.stream.pos + this.header + Math.abs(this.length);};ASN1.prototype.toHexString = function (root){return this.stream.hexDump(this.posStart(),this.posEnd(),true);};ASN1.decodeLength = function (stream){var buf = stream.get(),len = buf & 0x7F;if (len == buf) return len;if (len > 6) throw "Length over 48 bits not supported at position " + (stream.pos - 1);if (len === 0) return null;buf = 0;for (var i = 0;i < len;++i) buf = (buf * 256) + stream.get();return buf;};function ASN1Tag(stream){var buf = stream.get();this.tagClass = buf >> 6;this.tagConstructed = ((buf & 0x20) !== 0);this.tagNumber = buf & 0x1F;if (this.tagNumber == 0x1F){var n = new Int10();do{buf = stream.get();n.mulAdd(128,buf & 0x7F);} while (buf & 0x80);this.tagNumber = n.simplify();} } ASN1Tag.prototype.isUniversal = function (){return this.tagClass === 0x00;};ASN1Tag.prototype.isEOC = function (){return this.tagClass === 0x00 && this.tagNumber === 0x00;};ASN1.decode = function (stream){if (!(stream instanceof Stream)) stream = new Stream(stream,0);var streamStart = new Stream(stream),tag = new ASN1Tag(stream),len = ASN1.decodeLength(stream),start = stream.pos,header = start - streamStart.pos,sub = null,getSub = function (){sub = [];if (len !== null){var end = start + len;while (stream.pos < end) sub[sub.length] = ASN1.decode(stream);if (stream.pos != end) throw "Content size is not correct for container starting at offset " + start;} else{try{for (;;){var s = ASN1.decode(stream);if (s.tag.isEOC()) break;sub[sub.length] = s;} len = start - stream.pos;} catch (e){throw "Exception while decoding undefined length content:" + e;} } };if (tag.tagConstructed){getSub();} else if (tag.isUniversal() && ((tag.tagNumber == 0x03) || (tag.tagNumber == 0x04))){try{if (tag.tagNumber == 0x03) if (stream.get() != 0) throw "BIT STRINGs with unused bits cannot encapsulate.";getSub();for (var i = 0;i < sub.length;++i) if (sub[i].tag.isEOC()) throw 'EOC is not supposed to be actual content.';} catch (e){sub = null;} } if (sub === null){if (len === null) throw "We can't skip over an invalid tag with undefined length at offset " + start;stream.pos = start + Math.abs(len);} return new ASN1(streamStart,header,len,tag,sub);};if (typeof module !== 'undefined'){module.exports = ASN1;} else{window.ASN1 = ASN1;} })();(function (undefined){"use strict";var ASN1 = (typeof module !== 'undefined') ? require('./asn1.js'):window.ASN1,lineLength = 80,contentLength = 8 * lineLength,DOM ={ellipsis:"\u2026",tag:function (tagName,className){var t = document.createElement(tagName);t.className = className;return t;},text:function (str){return document.createTextNode(str);},breakLines:function (str,length){var lines = str.split(/\r?\n/),o = '';for (var i = 0;i < lines.length;++i){var line = lines[i];if (i > 0) o += "\n";while (line.length > length){o += line.substring(0,length);o += "\n";line = line.substring(length);} o += line;} return o;} };ASN1.prototype.toDOM = function (){var node = DOM.tag("div","node");node.asn1 = this;var head = DOM.tag("div","head");var s = this.typeName().replace(/_/g," ");head.innerHTML = s;var content = this.content(contentLength);if (content !== null){var preview = DOM.tag("span","preview"),shortContent;content = String(content);shortContent = (content.length > lineLength) ? content.substring(0,lineLength) + DOM.ellipsis:content;preview.appendChild(DOM.text(shortContent));head.appendChild(preview);content = DOM.breakLines(content,lineLength);content = content.replace(/</g,"&lt;");content = content.replace(/\n/g,"<br>");} node.appendChild(head);this.node = node;this.head = head;var value = DOM.tag("div","value");s = "Offset:" + this.stream.pos + "<br>";s += "Length:" + this.header + "+";if (this.length >= 0) s += this.length;else s += (-this.length) + " (undefined)";if (this.tag.tagConstructed) s += "<br>(constructed)";else if ((this.tag.isUniversal() && ((this.tag.tagNumber == 0x03) || (this.tag.tagNumber == 0x04))) && (this.sub !== null)) s += "<br>(encapsulates)";if (content !== null){s += "<br>Value:<br><b>" + content + "</b>";if ((typeof oids === 'object') && (this.tag.isUniversal() && (this.tag.tagNumber == 0x06))){var oid = oids[content];if (oid){if (oid.d) s += "<br>" + oid.d;if (oid.c) s += "<br>" + oid.c;if (oid.w) s += "<br>(warning!)";} } } value.innerHTML = s;node.appendChild(value);var sub = DOM.tag("div","sub");if (this.sub !== null){for (var i = 0,max = this.sub.length;i < max;++i) sub.appendChild(this.sub[i].toDOM());} node.appendChild(sub);head.onclick = function (){node.className = (node.className == "node collapsed") ? "node":"node collapsed";};return node;};ASN1.prototype.fakeHover = function (current){this.node.className += " hover";if (current) this.head.className += " hover";};ASN1.prototype.fakeOut = function (current){var re = / ?hover/;this.node.className = this.node.className.replace(re,"");if (current) this.head.className = this.head.className.replace(re,"");};ASN1.prototype.toHexDOM_sub = function (node,className,stream,start,end){if (start >= end) return;var sub = DOM.tag("span",className);sub.appendChild(DOM.text( stream.hexDump(start,end)));node.appendChild(sub);};ASN1.prototype.toHexDOM = function (root){var node = DOM.tag("span","hex");if (root === undefined) root = node;this.head.hexNode = node;this.head.onmouseover = function (){this.hexNode.className = "hexCurrent";};this.head.onmouseout = function (){this.hexNode.className = "hex";};node.asn1 = this;node.onmouseover = function (){var current = !root.selected;if (current){root.selected = this.asn1;this.className = "hexCurrent";} this.asn1.fakeHover(current);};node.onmouseout = function (){var current = (root.selected == this.asn1);this.asn1.fakeOut(current);if (current){root.selected = null;this.className = "hex";} };this.toHexDOM_sub(node,"tag",this.stream,this.posStart(),this.posStart() + 1);this.toHexDOM_sub(node,(this.length >= 0) ? "dlen":"ulen",this.stream,this.posStart() + 1,this.posContent());if (this.sub === null){var start = this.posContent();var end = this.posEnd();if (end - start < 10 * 16) node.appendChild(DOM.text( this.stream.hexDump(start,end)));else{var end1 = start + 5 * 16 - (start & 0xF);var start2 = end - 16 - (end & 0xF);node.appendChild(DOM.text( this.stream.hexDump(start,end1)));var sub = DOM.tag("span","skip");sub.appendChild(DOM.text("\u2026 skipping " + (start2 - end1) + " bytes \u2026\n"));node.appendChild(sub);node.appendChild(DOM.text( this.stream.hexDump(start2,end)));} } else if (this.sub.length > 0){var first = this.sub[0];var last = this.sub[this.sub.length - 1];this.toHexDOM_sub(node,"intro",this.stream,this.posContent(),first.posStart());for (var i = 0,max = this.sub.length;i < max;++i) node.appendChild(this.sub[i].toHexDOM(root));this.toHexDOM_sub(node,"outro",this.stream,last.posEnd(),this.posEnd());} else this.toHexDOM_sub(node,"outro",this.stream,this.posContent(),this.posEnd());return node;};})();(function(){var root = this,w = window,defaults ={log:false,lang:'en',backend:null},params = defaults;w.pkcs11_hwcrypto ={init:init,set:set_params,sign:sign_promise,certificate:get_cert };function init(){if (!window.hwcrypto){_log("E hwcrypto not found. Has it been linked ?");throw(hwcrypto_unavailable);} if (!window.hwcrypto.use(defaults.backend)){_log('E hwcrypto failed to select backend');throw(hwcrypto_unavailable);} window.hwcrypto.debug().then(function(response){_log("I ",response);});} function set_params(P){if (P.backend != null && P.backend != "chrome" && P.backend != "npapi") throw "pcks11_bad_backend";for (var key in P){if (P.hasOwnProperty(key)) params[key] = P[key] } _log("I Parameters set,current config:",params);return this;} function sign_promise(payload){var Type = payload.digest_alg;var cert = payload.cert;var HexHash = base64ToHex(payload.base64hash).toUpperCase();return window.hwcrypto.sign(cert,{type:Type,hex:HexHash},{lang:defaults.lang}) .then(function(signature){_log("I Signature Successful",signature);return signature;});} function get_cert(){return window.hwcrypto.getCertificate({lang:defaults.lang}) .then(function(resp){return{hex:resp.hex,raw:resp};});} function base64ToHex(str){for (var i = 0,bin = atob(str.replace(/[ \r\n]+$/,"")),hex = [];i < bin.length;++i){var tmp = bin.charCodeAt(i).toString(16);if (tmp.length === 1) tmp = "0" + tmp;hex[hex.length] = tmp;} return hex.join('');} function _log(){if (params.log && window.console && window.console.log) window.console.log.apply(console,arguments) };})();(function(){var root = this,w = window,defaults ={log:false,pkcs11:null,hashf:'SHA-256' },params = defaults;w.xmldsig_js ={set:set_params,sign:xmldsig_promise };function set_params(P){if (P.hashf != null && HashSettings[P.hashf] == null) throw 'xmldsig_hash_function_not_defined';for (var key in P){if (P.hasOwnProperty(key)) params[key] = P[key] } _log("I Parameters set,current config:",params);return this;} function xmldsig_promise(RawText){assert_only_unicode(RawText);if (params.pkcs11 == null) throw 'xmldsig_no_pkcs11_defined';return build_xmldsig(RawText);} var XML_MASK = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n"+ "<Signature %PROP%>\n"+ "%SIGNEDINFO%\n"+ "<SignatureValue>%SIGNATUREVALUE%</SignatureValue>\n"+ "%KEYINFO%\n"+ "%OBJECT%\n"+ "</Signature>";var XML_PROP = 'xmlns="http://www.w3.org/2000/09/xmldsig#"';var OBJ_MASK = "<Object%PROP% Id=\"object\">%OBJECT%</Object>";var SINFO_MASK = "<SignedInfo%PROP%>\n"+ " <CanonicalizationMethod Algorithm=\"http://www.w3.org/TR/2001/REC-xml-c14n-20010315\"></CanonicalizationMethod>\n"+ " <SignatureMethod Algorithm=\"%SIGN_ALGO%\"></SignatureMethod>\n"+ " <Reference URI=\"#object\">\n"+ " <DigestMethod Algorithm=\"%DIGEST_ALGO%\"></DigestMethod>\n"+ " <DigestValue>%DIGEST%</DigestValue>\n"+ " </Reference>\n"+ "</SignedInfo>";var KEYINFO_MASK = "<KeyInfo>\n"+ " <KeyValue>\n"+ " <RSAKeyValue>\n"+ " <Modulus>%MODULUS%</Modulus>\n"+ " <Exponent>%EXPONENT%</Exponent>\n"+ " </RSAKeyValue>\n"+ " </KeyValue>\n"+ " <X509Data>\n"+ " <X509SubjectName>%SUBJECTNAME%</X509SubjectName>\n"+ " <X509IssuerSerial>\n"+ " <X509IssuerName>%ISSUERNAME%</X509IssuerName>\n"+ " <X509IssuerSerialNumber>%ISSUERSERIAL%</X509IssuerSerialNumber>\n"+ " </X509IssuerSerial>\n"+ " <X509Certificate>%CERT%</X509Certificate>\n"+ " </X509Data>\n"+ "</KeyInfo>";var HashSettings ={'SHA-256':{xmldigest_signalgo:"http://www.w3.org/2001/04/xmldsig-more#rsa-sha256",xmldigest_digestalgo:"http://www.w3.org/2001/04/xmlenc#sha256"},'SHA-1':{xmldigest_signalgo:"http://www.w3.org/2000/09/xmldsig#rsa-sha1",xmldigest_digestalgo:"http://www.w3.org/2000/09/xmldsig#sha1"},'SHA-512':{xmldigest_signalgo:"http://www.w3.org/2001/04/xmldsig-more#rsa-sha512",xmldigest_digestalgo:"http://www.w3.org/2001/04/xmlenc#sha512"},'SHA-384':{xmldigest_signalgo:"http://www.w3.org/2001/04/xmldsig-more#rsa-sha384",xmldigest_digestalgo:"http://www.w3.org/2001/04/xmldsig-more#sha384"},'SHA-224':{xmldigest_signalgo:"http://www.w3.org/2001/04/xmldsig-more#rsa-sha224",xmldigest_digestalgo:"http://www.w3.org/2001/04/xmldsig-more#sha224"} };function build_xmldsig(Text){_log('I Preparing XMLDSig for ',Text);var CanonicalForm = compose_object(Text,true);_log('I Canonical form:',CanonicalForm);return defaults.pkcs11.certificate().then(function(Cert){var A = ASN1.decode(Hex.decode(Cert.hex));var C = X509_2_json(A);if (C.Certificate.Subject.SerialNumber != null && C.Certificate.Subject.UID == null) C.Certificate.Subject.UID = C.Certificate.Subject.SerialNumber;var KeyMatch = C.Certificate.SubjectPublicKeyInfo.SubjectPublicKey.Modulus.match(/\(([0-9]+).*\)/);var HashF = defaults.hashf;var SignF = defaults.hashf;if (KeyMatch[1] != null){if (KeyMatch[1] == '1024' && HashF != 'SHA-1'){_log('W Downgraded signature hash function to SHA-1:1024 bit key detected,crypto.subtle does not support SHA-224');SignF = 'SHA-1';HashF = 'SHA-1';} } var payload ={'cert_raw':Cert.raw,'cert_hex':Cert.hex,'cert_json':C,'keyLength':KeyMatch[1] != null ? KeyMatch[1]:'unknown','hashf':HashF,'signf':SignF};_log('I Initalizing payload:',payload);return hash_promise(CanonicalForm,payload.hashf).then(function(Digest){payload.digest = Digest;return payload;});},function(err){_log('E get certificate failed',err);throw('xmldsig_failed_cert_retrieval');}) .then(function(payload){var ToSign = compose_signedinfo(payload.digest,true,payload.hashf,payload.signf);_log('I To Sign:',ToSign);return hash_promise(ToSign,payload.hashf).then(function(signedinfo_digest){payload.sign_digest = signedinfo_digest;return payload });}) .then(function(payload){var PKCS11_payload ={'base64hash':payload.sign_digest,'digest_alg':payload.signf,'cert':payload.cert_raw};_log('I PKCS11 Payload',PKCS11_payload);return defaults.pkcs11.sign(PKCS11_payload) .then(function(signature){payload.sign_hex = signature.hex;return payload });}) .then(function(payload){var Signature = hexToBase64(payload.sign_hex);_log('I Signature:',Signature);return compose_xml(compose_object(Text),compose_signedinfo(payload.digest,false,payload.hashf,payload.signf),compose_keyinfo(payload.cert_json,payload.cert_hex),Signature);});} function compose_object(RawText,Canonical){var Canonical = Canonical || false;var CleanText = c14n_text(RawText);var ExtProp = Canonical ? ' ' + XML_PROP:'';return OBJ_MASK.replace('%OBJECT%',CleanText) .replace('%PROP%',ExtProp);} function compose_signedinfo(Digest,Canonical,HashF,SignF){var Canonical = Canonical || false;var ExtProp = Canonical ? ' ' + XML_PROP:'';return SINFO_MASK.replace('%DIGEST%',Digest) .replace('%SIGN_ALGO%',HashSettings[SignF].xmldigest_signalgo) .replace('%DIGEST_ALGO%',HashSettings[HashF].xmldigest_digestalgo) .replace('%PROP%',ExtProp);} function compose_keyinfo(C,KeyHex){var Exponent = integer2base64(C.Certificate.SubjectPublicKeyInfo.SubjectPublicKey.Exponent);var RawMod = C.Certificate.SubjectPublicKeyInfo.SubjectPublicKey.Modulus;var CleanMod = RawMod.replace(/^\(.*\)[^0-9]*/,'');var Modulus = integer2base64(CleanMod);return KEYINFO_MASK.replace('%CERT%',format_b64(hexToBase64(KeyHex),4)) .replace('%ISSUERSERIAL%',C.Certificate.Issuer.SerialNumber) .replace('%ISSUERNAME%',compose_ldapname(C.Certificate.Issuer)) .replace('%SUBJECTNAME%',compose_ldapname(C.Certificate.Subject)) .replace('%EXPONENT%',Exponent) .replace('%MODULUS%',format_b64(Modulus,6));} function compose_ldapname(D){console.log(D);var Out = [];var Check = ['CN','L','ST','O','OU','C','STREET','DC','UID'];for (var i=0,l=Check.length;i<l;i++){var el = Check[i];if (D.hasOwnProperty(el)) Out.push(el+'='+c14n_text(D[el].replace(/,/g,'\,')));} return Out.join(',');} function compose_xml(Obj,SignedInfo,KeyInfo,Signature){return XML_MASK.replace('%OBJECT%',Obj) .replace('%SIGNEDINFO%',SignedInfo) .replace('%KEYINFO%',KeyInfo) .replace('%SIGNATUREVALUE%',format_b64(Signature)) .replace('%PROP%',XML_PROP);} function hash_promise(Str,HashF){console.log(HashF);var buffer = new TextEncoder("utf-8").encode(Str);return crypto.subtle.digest(HashF,buffer) .then(function (hashed){return hexToBase64(hex(hashed));});} function hex(buffer){var hexCodes = [];var view = new DataView(buffer);for (var i = 0;i < view.byteLength;i += 4){var value = view.getUint32(i);var stringValue = value.toString(16);var padding = '00000000';var paddedValue = (padding + stringValue).slice(-padding.length);hexCodes.push(paddedValue);} return hexCodes.join("");} function _log(){if (params.log && window.console && window.console.log) window.console.log.apply(console,arguments) } function integer2base64(IntStr){return hexToBase64(dec2hex(IntStr));} function format_b64(RawIn,Indent){var Out = [],buffer = [],pos=0;var Indent = Indent || 0;var Prefix = new Array(Indent + 1).join(' ');var In = RawIn.split('').reverse();while (In.length){buffer.push(In.pop());if (buffer.length == 64){Out.push(Prefix + buffer.join(''));buffer = [];} } if (buffer.length > 0) Out.push(Prefix + buffer.join(''));return Out.join("\n").trim();} function c14n_text(Str){Str = Str.replace(/\r/g,'');Str = Str.replace(/&/g,'&amp;');Str = Str.replace(/</g,'&lt;');Str = Str.replace(/>/g,'&gt;');return Str;} function assert_only_unicode(Str){try{encodeURIComponent(Str) } catch(e){throw('xmldsig_bad_input_string_encoding');} } function hexToBase64(str){return btoa(String.fromCharCode .apply(null,str.replace(/\r|\n/g,"") .replace(/([\da-fA-F]{2}) ?/g,"0x$1 ") .replace(/ +$/,"") .split(" ") ));} function dec2hex(str){var dec = str.toString().split(''),sum = [],hex = [],i,s;while(dec.length){s = 1 * dec.shift();for(i = 0;s || i < sum.length;i++){s += (sum[i] || 0) * 10;sum[i] = s % 16;s = (s - sum[i]) / 16;} } if (sum.length % 2 > 0) sum.push('0');while(sum.length) hex.push(sum.pop().toString(16));return hex.join('');} function sequence_convert(Part,A){var S = get_sequence(Part,A);return sequence_2_json(S,A);} function sequence_2_json(S){if (S == null) return null;if (!S.tag.tagConstructed) return S.content();if (S.sub.length == 1){if (S.tag.tagConstructed) return sequence_2_json(S.sub[0]);else return S.sub[0].content();} if (S.sub.length == 2 && S.sub[0].typeName() == 'OBJECT_IDENTIFIER'){var key = oid2description(S.sub[0].content());if (S.sub[1].typeName() == 'NULL') return key;var val = S.sub[1].content();return eval('({\''+key+'\':\''+val+'\'})');} if (S.sub[0].typeName() == 'SET'){var Out ={};for (var i=0,l=S.sub.length;i<l;i++){var Temp = sequence_2_json(S.sub[i]);for (var key in Temp) Out[key] = Temp[key];} return Out;} _log('E Sequence fail to jsonize:',S);return "Sequence case not defined";} function get_sequence(Part,A){var N = cert_has_version(A) ? 0:1;switch (Part){case 'Certificate':return A.sub[0];case 'Certificate Signature Algorithm':return A.sub[1];case 'Certificate Signature':return A.sub[2];case 'Version':return N == 0 ? get_sequence('Certificate',A).sub[0]:null;case 'Serial Number':return get_sequence('Certificate',A).sub[1-N];case 'Algorithm ID':return get_sequence('Certificate',A).sub[2-N];case 'Issuer':return get_sequence('Certificate',A).sub[3-N];case 'Validity':return get_sequence('Certificate',A).sub[4-N];case 'Not Before':return get_sequence('Validity',A).sub[0];case 'Not After':return get_sequence('Validity',A).sub[1];case 'Subject':return get_sequence('Certificate',A).sub[5-N];case 'Subject Public Key Info':return get_sequence('Certificate',A).sub[6-N];case 'Public Key Algorithm':return get_sequence('Subject Public Key Info',A).sub[0];case 'Subject Public Key':return get_sequence('Subject Public Key Info',A).sub[1];case 'RSA Modulus':return get_sequence('Subject Public Key',A).sub[0].sub[0];case 'RSA Exponent':return get_sequence('Subject Public Key',A).sub[0].sub[1];} } function X509_2_json(X509){return{'Certificate':{'Version':sequence_convert('Version',X509),'SerialNumber':sequence_convert('Serial Number',X509),'AlgorithmID':sequence_convert('Algorithm ID',X509),'Issuer':sequence_convert('Issuer',X509),'Validity':{'NotBefore':sequence_convert('Not Before',X509),'NotAfter':sequence_convert('Not After',X509)},'Subject':sequence_convert('Subject',X509),'SubjectPublicKeyInfo':{'PublicKeyAlgorithm':sequence_convert('Public Key Algorithm',X509),'SubjectPublicKey':{'Modulus':sequence_convert('RSA Modulus',X509),'Exponent':sequence_convert('RSA Exponent',X509) } } } };} var oid2key ={'1.2.840.113549.1.1.5':'sha1WithRSAEncryption','1.2.840.113549.1.1.1':'rsaEncryption','1.2.840.113549.1.1.11':'sha256WithRSAEncryption','2.5.4.3':'CN','2.5.4.4':'SN','2.5.4.42':'GN','2.5.4.11':'OU','2.5.4.10':'O','2.5.4.7':'L','2.5.4.8':'S','2.5.4.6':'C','2.5.4.5':'SerialNumber' };function cert_has_version(A){var VersionSeq = A.sub[0].sub[0];if (VersionSeq.sub == null || VersionSeq.sub[0] == null || VersionSeq.sub[0].typeName() != "INTEGER") return false;return true;} function oid2description(Oid){var t = oid2key[Oid];return t != null ? t:Oid;} })();